<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TA/DA Calculation Sheet (Multi Tour Range + PDF + Excel)</title>

<!-- PDF + Excel libs (NO PRINT) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --border:#000;
    --bg:#f2f4f7;
    --card:#fff;
    --head:#f0f0f0;
    --btn:#0b5ed7;
    --btn2:#198754;
    --btn3:#6c757d;
    --danger:#dc3545;
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:Arial,system-ui;padding:10px}
  .wrap{max-width:1500px;margin:auto}

  .toolbar{
    display:flex;flex-wrap:wrap;gap:8px;
    background:var(--card);border:1px solid var(--border);
    padding:10px;border-radius:8px;margin-bottom:10px;
    align-items:flex-end;
  }
  .field{display:flex;flex-direction:column;gap:4px}
  .field label{font-size:12px;font-weight:700}
  .field input,.field select{
    height:34px;padding:6px 8px;border:1px solid #c7c7c7;border-radius:6px;
    font-size:13px;min-width:170px;background:#fff;
  }
  .field.small input{min-width:120px}
  .field.tiny input{min-width:90px}
  .field.tiny select{min-width:220px}

  .toggle{
    display:flex;align-items:center;gap:8px;
    height:34px;padding:0 10px;border:1px solid #c7c7c7;border-radius:6px;background:#fff;
    font-size:13px;
    user-select:none;
  }
  .toggle input{width:16px;height:16px;margin:0}

  .btn{
    height:34px;border:none;border-radius:6px;
    padding:0 12px;color:#fff;font-weight:800;cursor:pointer;font-size:13px;
  }
  .btn.primary{background:var(--btn)}
  .btn.success{background:var(--btn2)}
  .btn.gray{background:var(--btn3)}
  .btn.danger{background:var(--danger)}
  .btn:active{transform:translateY(1px)}
  .hint{font-size:12px;color:#333;margin-left:auto;max-width:720px}

  .rateBadge{
    height:34px;display:flex;align-items:center;gap:8px;
    padding:0 10px;border-radius:6px;border:1px dashed #9aa4b2;background:#fff;
    font-size:12px;
  }
  .rateBadge b{font-size:12px}

  /* Multi range area */
  .ranges{
    width:100%;
    border:1px dashed #b8c0cc;
    border-radius:8px;
    padding:10px;
    background:#fff;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .rangesHead{
    display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .rangesHead .title{
    font-weight:900;font-size:13px;
  }
  .rangeRow{
    display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;
    padding:8px;border:1px solid #e3e7ee;border-radius:8px;background:#fafbfc;
  }
  .rangeRow .field input{min-width:160px}
  .rangeTag{
    font-size:12px;font-weight:900;background:#eef2ff;border:1px solid #c7d2fe;
    padding:6px 10px;border-radius:999px;height:34px;display:flex;align-items:center;
  }

  /* Sheet */
  #taDaSheet{
    background:var(--card);border:1px solid var(--border);
    padding:10px;border-radius:8px;
  }

  table{width:100%;border-collapse:collapse}
  .header-grid td{
    border:1px solid var(--border);
    padding:6px;
    font-size:12px;
  }
  .header-title{
    text-align:center;font-weight:900;font-size:14px;background:var(--head);
  }

  .main th,.main td{
    border:1px solid var(--border);
    text-align:center;
    padding:3px 4px;
    font-size:11px;
    line-height:1.1;
    vertical-align:middle;
  }
  .main th{background:var(--head);font-weight:900}

  .main input,.main select{
    width:100%;
    border:none;
    background:transparent;
    text-align:center;
    font-size:11px;
    padding:0;
    height:18px;
    outline:none;
    color:#000;
    -webkit-text-fill-color:#000;
    opacity:1;
  }
  .main td{height:22px}
  .right{text-align:right}

  .footer{
    display:flex;justify-content:space-between;gap:10px;
    margin-top:8px;font-size:11px;
  }
  .line{
    border-bottom:1px solid #000;display:inline-block;min-width:180px;height:12px;vertical-align:bottom;
  }

  .pdf-compact .main td{height:20px}
  .pdf-compact .main input,.pdf-compact .main select{height:16px;font-size:10px}
  .pdf-compact .main th{font-size:10px}
  .pdf-compact .main td{font-size:10px}
</style>
</head>

<body>
<div class="wrap">

  <!-- ===== TOOLBAR ===== -->
  <div class="toolbar">
    <div class="field">
      <label>नाम / Name</label>
      <input id="name" placeholder="Name" />
    </div>

    <div class="field">
      <label>पदनाम / Designation</label>
      <select id="designation">
        <option value="">Select</option>
        <option value="Senior Statistical Officer">Senior Statistical Officer</option>
        <option value="Survey Supervisor">Survey Supervisor</option>
        <option value="Survey Enumerator">Survey Enumerator</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <div class="field small">
      <label>स्थान / Place</label>
      <input id="place" placeholder="Place" />
    </div>

    <div class="toggle" title="Designation select karte hi DA/Hotel rates auto set honge">
      <input id="autoRates" type="checkbox" checked />
      <span><b>Auto rates</b> by designation</span>
    </div>

    <div class="toggle" title="ON = Hotel auto fill (each range last day blank). Manual entry allowed.">
      <input id="autoHotel" type="checkbox" checked />
      <span><b>Auto Hotel</b> claim</span>
    </div>

    <div class="field tiny">
      <label>DA (₹)</label>
      <input id="rateDA" type="number" value="500" />
    </div>
    <div class="field tiny">
      <label>Hotel (₹)</label>
      <input id="rateHotel" type="number" value="750" />
    </div>

    <div class="rateBadge">
      <span>Applied:</span>
      <b id="appliedRateText">DA 500 | Hotel 750</b>
    </div>

    <!-- MULTI RANGE PANEL -->
    <div class="ranges">
      <div class="rangesHead">
        <div class="title">Multi Tour Ranges</div>
        <button class="btn gray" type="button" onclick="addRangeUI()">+ Add Range</button>
        <div style="font-size:12px;color:#333">
          Tip: Same date can appear in multiple ranges → multiple rows (supports multiple journeys).
        </div>
      </div>

      <div id="rangesContainer"></div>
    </div>

    <button class="btn success" onclick="generateRows()">Generate Rows</button>
    <button class="btn gray" onclick="addRow()">+ Add Row</button>
    <button class="btn gray" onclick="clearAll()">Clear</button>

    <button class="btn primary" onclick="exportPDF()">⬇️ PDF</button>
    <button class="btn primary" onclick="exportExcel()">⬇️ Excel</button>

    <div class="hint">
      ✅ Multi tour ranges • ✅ End-date row fixed (timezone safe) • ✅ Blank stays blank • ✅ Save/Restore
    </div>
  </div>

  <!-- ===== SHEET ===== -->
  <div id="taDaSheet">
    <table class="header-grid">
      <tr>
        <td colspan="8" class="header-title">दौरा भत्ता / दैनिक भत्ता गणना शीट  @ TA/DA CALCULATION SHEET</td>
      </tr>
      <tr>
        <td class="right"><b>नाम/Name</b></td>
        <td colspan="3"><span id="hName">-</span></td>
        <td class="right"><b>पदनाम/Designation</b></td>
        <td colspan="3"><span id="hDesig">-</span></td>
      </tr>
      <tr>
        <td class="right"><b>स्थान/Place</b></td>
        <td colspan="3"><span id="hPlace">-</span></td>
        <td class="right"><b>माह/Month</b></td>
        <td><span id="hMonth">-</span></td>
        <td class="right"><b>वर्ष/Year</b></td>
        <td><span id="hYear">-</span></td>
      </tr>
    </table>

    <table class="main" id="tadaTable">
      <thead>
        <tr>
          <th style="width:110px">Date</th>
          <th style="width:85px">No. of DA</th>
          <th style="width:80px">DA</th>
          <th style="width:90px">Hotel Bill</th>
          <th style="width:95px">Total DA</th>
          <th style="width:90px">Mode</th>
          <th style="width:85px">K.M.</th>
          <th style="width:95px">Total Fare</th>
          <th style="width:95px">Grand Total</th>
        </tr>
      </thead>

      <tbody id="rows"></tbody>

      <tfoot>
        <tr>
          <th colspan="1">Grand Total</th>
          <th id="gt_daCount">0</th>
          <th id="gt_da">0</th>
          <th id="gt_hotel">0</th>
          <th id="gt_totalDA">0</th>
          <th colspan="2"></th>
          <th id="gt_fare">0</th>
          <th id="gt_grand">0</th>
        </tr>
      </tfoot>
    </table>

    <div class="footer" id="footerLine">
      <div>दिनांक: <span class="line"></span></div>
      <div>सम्बन्धित क्षेत्र कर्मचारी के हस्ताक्षर: <span class="line"></span></div>
    </div>
  </div>
</div>

<script>
/* =========================
   MULTI TOUR RANGE VERSION
   - Multiple ranges UI
   - Generate rows per range (duplicates allowed)
   - Auto Hotel per range: last day blank
   - Blank stays blank
   - To-date timezone safe dates
   ========================= */

const LS_KEY = "tada_sheet_multi_ranges_v1";

/* Designation-wise rates */
const DESIGNATION_RATES = {
  "Senior Statistical Officer": { da: 1000, hotel: 960 },
  "Survey Supervisor":         { da: 500,  hotel: 750 },
  "Survey Enumerator":         { da: 400,  hotel: 750 },
  "Other":                     { da: 500,  hotel: 750 }
};

/* ===== helpers ===== */
function parseNum(v){
  const s = String(v ?? "").trim();
  if(s === "") return 0;
  const x = Number(s.replace(/[^0-9.\-]/g,""));
  return isNaN(x) ? 0 : x;
}
function fmtINR(n){ return Math.round(Number(n||0)).toString(); }
function isBlank(v){ return String(v ?? "").trim() === ""; }
function setValIfDifferent(el, v){ if(el.value !== v) el.value = v; }

/* timezone-safe local ISO */
function toLocalISO(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

/* ===== header ===== */
function setHeaderFromInputs(){
  const name = document.getElementById("name").value.trim() || "-";
  const desig = document.getElementById("designation").value || "-";
  const place = document.getElementById("place").value.trim() || "-";
  document.getElementById("hName").textContent = name;
  document.getElementById("hDesig").textContent = desig;
  document.getElementById("hPlace").textContent = place;

  // month/year from first valid range-from; else today
  const ranges = getRanges();
  const firstFrom = (ranges.find(r=>r.from)?.from) || "";
  const d = firstFrom ? new Date(firstFrom + "T00:00:00") : new Date();
  document.getElementById("hMonth").textContent = d.toLocaleString("en-US",{month:"long"});
  document.getElementById("hYear").textContent = d.getFullYear();
  updateRateBadge();
}

function updateRateBadge(){
  const da = parseNum(document.getElementById("rateDA").value);
  const ht = parseNum(document.getElementById("rateHotel").value);
  document.getElementById("appliedRateText").textContent = `DA ${da} | Hotel ${ht}`;
}

function applyDesignationRates(){
  if(!document.getElementById("autoRates").checked) { updateRateBadge(); return; }
  const desig = document.getElementById("designation").value || "";
  const r = DESIGNATION_RATES[desig];
  if(!r){ updateRateBadge(); return; }

  document.getElementById("rateDA").value = r.da;
  document.getElementById("rateHotel").value = r.hotel;

  document.querySelectorAll("#rows tr").forEach(tr=>recalcRow(tr));
  recalcTotals();
  saveAll();
  updateRateBadge();
}

/* ===== ranges UI ===== */
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function addRangeUI(prefill={from:"",to:""}){
  const id = uid();
  const wrap = document.createElement("div");
  wrap.className = "rangeRow";
  wrap.dataset.rangeId = id;

  wrap.innerHTML = `
    <div class="rangeTag">Range</div>
    <div class="field small">
      <label>From</label>
      <input type="date" class="rg_from" value="${prefill.from||""}">
    </div>
    <div class="field small">
      <label>To</label>
      <input type="date" class="rg_to" value="${prefill.to||""}">
    </div>
    <button class="btn danger" type="button" title="Remove range">Remove</button>
  `;

  const btnRemove = wrap.querySelector(".btn.danger");
  btnRemove.addEventListener("click", ()=>{
    wrap.remove();
    setHeaderFromInputs();
    saveAll();
  });

  wrap.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input", ()=>{ setHeaderFromInputs(); saveAll(); });
    inp.addEventListener("change", ()=>{ setHeaderFromInputs(); saveAll(); });
  });

  document.getElementById("rangesContainer").appendChild(wrap);
  setHeaderFromInputs();
  saveAll();
}

function getRanges(){
  return [...document.querySelectorAll("#rangesContainer .rangeRow")].map((row, idx)=>({
    id: row.dataset.rangeId || String(idx+1),
    from: row.querySelector(".rg_from").value || "",
    to: row.querySelector(".rg_to").value || ""
  }));
}

/* timezone-safe range list */
function dateRange(from, to){
  const out=[];
  if(!from || !to) return out;

  const d1 = new Date(from + "T00:00:00");
  const d2 = new Date(to + "T00:00:00");
  if(isNaN(d1) || isNaN(d2)) return out;

  d1.setHours(0,0,0,0);
  d2.setHours(0,0,0,0);
  if(d2 < d1) return out;

  for(let d=new Date(d1); d<=d2; d.setDate(d.getDate()+1)){
    out.push(new Date(d));
  }
  return out;
}

/* ===== table rows ===== */
function renderModeOptions(selected){
  const modes = ["", "Bus", "Taxi", "Train", "Own Vehicle", "Other"];
  return modes.map(m=>{
    const sel = (m === (selected||"")) ? "selected" : "";
    return `<option value="${m}" ${sel}>${m}</option>`;
  }).join("");
}

function makeRow(data={}){
  const tr = document.createElement("tr");

  // link row to a range + range end date for "last day hotel blank"
  tr.dataset.rangeId = data.rangeId || "";
  tr.dataset.rangeEnd = data.rangeEnd || ""; // ISO yyyy-mm-dd
  tr.dataset.hotelManual = data.hotelManual ? "1" : "0";

  tr.innerHTML = `
    <td><input type="date" class="r_date" value="${data.date||""}"></td>
    <td><input type="number" min="0" step="1" class="r_noDA" value="${data.noDA ?? ""}"></td>
    <td><input type="number" min="0" step="1" class="r_DA" value="${data.DA ?? ""}"></td>
    <td><input type="number" min="0" step="1" class="r_hotel" value="${data.hotel ?? ""}" title="Type = manual override"></td>
    <td><input type="number" min="0" step="1" class="r_totalDA" value="${data.totalDA ?? ""}" readonly></td>
    <td><select class="r_mode">${renderModeOptions(data.mode)}</select></td>
    <td><input type="number" min="0" step="1" class="r_km" value="${data.km ?? ""}"></td>
    <td><input type="number" min="0" step="1" class="r_fare" value="${data.fare ?? ""}"></td>
    <td><input type="number" min="0" step="1" class="r_grand" value="${data.grand ?? ""}" readonly></td>
  `;

  const hotelInput = tr.querySelector(".r_hotel");
  hotelInput.addEventListener("input", ()=>{
    tr.dataset.hotelManual = isBlank(hotelInput.value) ? "0" : "1";
    recalcRow(tr); recalcTotals(); saveAll();
  });

  tr.querySelectorAll("input,select").forEach(el=>{
    if(el === hotelInput) return;
    el.addEventListener("input", ()=>{ recalcRow(tr); recalcTotals(); saveAll(); });
    el.addEventListener("change", ()=>{ recalcRow(tr); recalcTotals(); saveAll(); setHeaderFromInputs(); });
  });

  recalcRow(tr);
  return tr;
}

/* per-row last day (based on that row's rangeEnd) */
function isRowLastDay(tr, dateISO){
  const end = tr.dataset.rangeEnd || "";
  if(!end || !dateISO) return false;
  return dateISO === end;
}
function shouldAutoHotel(tr){
  return document.getElementById("autoHotel").checked && tr.dataset.hotelManual !== "1";
}
function applyAutoHotelIfNeeded(tr){
  if(!shouldAutoHotel(tr)) return;

  const rateHotel = parseNum(document.getElementById("rateHotel").value);
  const dateISO = tr.querySelector(".r_date").value || "";
  const noDAraw = tr.querySelector(".r_noDA").value;

  if(isBlank(noDAraw) || parseNum(noDAraw) <= 0){
    setValIfDifferent(tr.querySelector(".r_hotel"), "");
    return;
  }
  if(isRowLastDay(tr, dateISO)){
    setValIfDifferent(tr.querySelector(".r_hotel"), "");
    return;
  }
  setValIfDifferent(tr.querySelector(".r_hotel"), String(rateHotel));
}

function recalcRow(tr){
  const rateDA = parseNum(document.getElementById("rateDA").value);
  const noDAraw = tr.querySelector(".r_noDA").value;

  if(isBlank(noDAraw) || parseNum(noDAraw) <= 0){
    setValIfDifferent(tr.querySelector(".r_DA"), "");
  }else{
    const computedDA = parseNum(noDAraw) * rateDA;
    setValIfDifferent(tr.querySelector(".r_DA"), String(computedDA));
  }

  applyAutoHotelIfNeeded(tr);

  const DAraw = tr.querySelector(".r_DA").value;
  const hotelRaw = tr.querySelector(".r_hotel").value;
  const fareRaw = tr.querySelector(".r_fare").value;

  const DA = parseNum(DAraw);
  const hotel = parseNum(hotelRaw);
  const fare = parseNum(fareRaw);

  const totalDAEl = tr.querySelector(".r_totalDA");
  if(isBlank(DAraw) && isBlank(hotelRaw)){
    setValIfDifferent(totalDAEl, "");
  }else{
    setValIfDifferent(totalDAEl, String(DA + hotel));
  }

  const grandEl = tr.querySelector(".r_grand");
  if(isBlank(totalDAEl.value) && isBlank(fareRaw)){
    setValIfDifferent(grandEl, "");
  }else{
    setValIfDifferent(grandEl, String((DA + hotel) + fare));
  }
}

function recalcTotals(){
  const trs = [...document.querySelectorAll("#rows tr")];
  let daCount=0, da=0, hotel=0, totalDA=0, fare=0, grand=0;

  trs.forEach(tr=>{
    daCount += parseNum(tr.querySelector(".r_noDA").value);
    da += parseNum(tr.querySelector(".r_DA").value);
    hotel += parseNum(tr.querySelector(".r_hotel").value);
    totalDA += parseNum(tr.querySelector(".r_totalDA").value);
    fare += parseNum(tr.querySelector(".r_fare").value);
    grand += parseNum(tr.querySelector(".r_grand").value);
  });

  document.getElementById("gt_daCount").textContent = fmtINR(daCount);
  document.getElementById("gt_da").textContent = fmtINR(da);
  document.getElementById("gt_hotel").textContent = fmtINR(hotel);
  document.getElementById("gt_totalDA").textContent = fmtINR(totalDA);
  document.getElementById("gt_fare").textContent = fmtINR(fare);
  document.getElementById("gt_grand").textContent = fmtINR(grand);
}

function addRow(prefill={}){
  document.getElementById("rows").appendChild(makeRow(prefill));
  recalcTotals();
  saveAll();
}

/* ===== generate rows for all ranges ===== */
function generateRows(){
  const ranges = getRanges().filter(r=>r.from && r.to);
  if(!ranges.length){
    if(!document.querySelector("#rows tr")) addRow({});
    setHeaderFromInputs();
    return;
  }

  document.getElementById("rows").innerHTML = "";

  // IMPORTANT: duplicates allowed
  ranges.forEach((rg, i)=>{
    const list = dateRange(rg.from, rg.to);
    const endISO = rg.to; // already yyyy-mm-dd
    list.forEach(d=>{
      const iso = toLocalISO(d);
      addRow({
        date: iso,
        noDA: 1,              // default 1 (you can clear -> becomes blank)
        rangeId: rg.id,
        rangeEnd: endISO,
        hotelManual: 0
      });
    });
  });

  document.querySelectorAll("#rows tr").forEach(tr=>recalcRow(tr));
  setHeaderFromInputs();
  recalcTotals();
  saveAll();
}

function clearAll(){
  document.getElementById("rows").innerHTML = "";
  recalcTotals();
  saveAll();
}

/* ===== save/restore ===== */
function saveAll(){
  const payload = {
    meta:{
      name: document.getElementById("name").value || "",
      designation: document.getElementById("designation").value || "",
      place: document.getElementById("place").value || "",
      autoRates: document.getElementById("autoRates").checked ? 1 : 0,
      autoHotel: document.getElementById("autoHotel").checked ? 1 : 0,
      rateDA: document.getElementById("rateDA").value || "500",
      rateHotel: document.getElementById("rateHotel").value || "750",
    },
    ranges: getRanges(),
    rows: [...document.querySelectorAll("#rows tr")].map(tr=>({
      date: tr.querySelector(".r_date").value || "",
      noDA: tr.querySelector(".r_noDA").value || "",
      DA: tr.querySelector(".r_DA").value || "",
      hotel: tr.querySelector(".r_hotel").value || "",
      hotelManual: tr.dataset.hotelManual === "1" ? 1 : 0,
      totalDA: tr.querySelector(".r_totalDA").value || "",
      mode: tr.querySelector(".r_mode").value || "",
      km: tr.querySelector(".r_km").value || "",
      fare: tr.querySelector(".r_fare").value || "",
      grand: tr.querySelector(".r_grand").value || "",
      rangeId: tr.dataset.rangeId || "",
      rangeEnd: tr.dataset.rangeEnd || ""
    }))
  };
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
}

function loadAll(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return false;
  try{
    const data = JSON.parse(raw);
    const m = data.meta || {};

    document.getElementById("name").value = m.name || "";
    document.getElementById("designation").value = m.designation || "";
    document.getElementById("place").value = m.place || "";
    document.getElementById("autoRates").checked = (m.autoRates ?? 1) ? true : false;
    document.getElementById("autoHotel").checked = (m.autoHotel ?? 1) ? true : false;

    document.getElementById("rateDA").value = m.rateDA || "500";
    document.getElementById("rateHotel").value = m.rateHotel || "750";

    // ranges
    const rc = document.getElementById("rangesContainer");
    rc.innerHTML = "";
    const ranges = data.ranges || [];
    if(ranges.length){
      ranges.forEach(r=> addRangeUI({from:r.from||"", to:r.to||""}));
      // keep same ids? we regenerate new ids; not needed
    }else{
      addRangeUI();
    }

    // rows
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";
    (data.rows || []).forEach(r=>{
      addRow({
        date: r.date||"",
        noDA: r.noDA ?? "",
        DA: r.DA ?? "",
        hotel: r.hotel ?? "",
        totalDA: r.totalDA ?? "",
        mode: r.mode ?? "",
        km: r.km ?? "",
        fare: r.fare ?? "",
        grand: r.grand ?? "",
        hotelManual: r.hotelManual ? 1 : 0,
        rangeId: r.rangeId || "",
        rangeEnd: r.rangeEnd || ""
      });
    });

    setHeaderFromInputs();
    document.querySelectorAll("#rows tr").forEach(tr=>recalcRow(tr));
    recalcTotals();
    updateRateBadge();
    return true;
  }catch(e){
    return false;
  }
}

/* ===== bindings ===== */
function bindMeta(){
  ["name","place","rateDA","rateHotel"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("input", ()=>{
      setHeaderFromInputs();
      document.querySelectorAll("#rows tr").forEach(tr=>recalcRow(tr));
      recalcTotals();
      saveAll();
    });
    el.addEventListener("change", ()=>{
      setHeaderFromInputs();
      document.querySelectorAll("#rows tr").forEach(tr=>recalcRow(tr));
      recalcTotals();
      saveAll();
    });
  });

  document.getElementById("designation").addEventListener("change", ()=>{
    setHeaderFromInputs();
    applyDesignationRates();
    saveAll();
  });

  document.getElementById("autoRates").addEventListener("change", ()=>{
    applyDesignationRates();
    saveAll();
  });

  document.getElementById("autoHotel").addEventListener("change", ()=>{
    document.querySelectorAll("#rows tr").forEach(tr=>recalcRow(tr));
    recalcTotals();
    saveAll();
  });
}

/* ===== PDF ===== */
function makeFileName(prefix, ext){
  const nm = (document.getElementById("name").value || "User").trim().replace(/\s+/g,"_");
  const des = (document.getElementById("designation").value || "").trim().replace(/\s+/g,"_");
  return `${prefix}_${nm}${des?("_"+des):""}.${ext}`;
}
function exportPDF(){
  const sheet = document.getElementById("taDaSheet");
  sheet.classList.add("pdf-compact");

  const opt = {
    margin: 5,
    filename: makeFileName("TA_DA_Sheet", "pdf"),
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "mm", format: "a4", orientation: "landscape" },
    pagebreak: { mode: ["avoid-all"] }
  };

  html2pdf().set(opt).from(sheet).save().finally(()=> sheet.classList.remove("pdf-compact"));
}

/* ===== EXCEL ===== */
function exportExcel(){
  const wb = XLSX.utils.book_new();
  const aoa = [];

  const name = document.getElementById("hName").textContent;
  const desig = document.getElementById("hDesig").textContent;
  const place = document.getElementById("hPlace").textContent;
  const month = document.getElementById("hMonth").textContent;
  const year = document.getElementById("hYear").textContent;

  const rateDA = parseNum(document.getElementById("rateDA").value);
  const rateHotel = parseNum(document.getElementById("rateHotel").value);

  // add ranges summary
  const ranges = getRanges().filter(r=>r.from && r.to);
  const rangesText = ranges.length ? ranges.map((r,i)=>`R${i+1}:${r.from}→${r.to}`).join(" | ") : "-";

  aoa.push(["TA/DA CALCULATION SHEET"]);
  aoa.push([]);
  aoa.push(["Name", name, "", "", "Designation", desig]);
  aoa.push(["Place", place, "", "", "Month", month, "Year", year]);
  aoa.push(["Rates Applied", `DA: ${rateDA}`, `Hotel: ${rateHotel}`]);
  aoa.push(["Tour Ranges", rangesText]);
  aoa.push([]);
  aoa.push(["Date","No. of DA","DA","Hotel Bill","Total DA","Mode","K.M.","Total Fare","Grand Total"]);

  document.querySelectorAll("#rows tr").forEach(tr=>{
    aoa.push([
      tr.querySelector(".r_date").value || "",
      tr.querySelector(".r_noDA").value || "",
      tr.querySelector(".r_DA").value || "",
      tr.querySelector(".r_hotel").value || "",
      tr.querySelector(".r_totalDA").value || "",
      tr.querySelector(".r_mode").value || "",
      tr.querySelector(".r_km").value || "",
      tr.querySelector(".r_fare").value || "",
      tr.querySelector(".r_grand").value || "",
    ]);
  });

  aoa.push([]);
  aoa.push([
    "Grand Total",
    parseNum(document.getElementById("gt_daCount").textContent),
    parseNum(document.getElementById("gt_da").textContent),
    parseNum(document.getElementById("gt_hotel").textContent),
    parseNum(document.getElementById("gt_totalDA").textContent),
    "",
    "",
    parseNum(document.getElementById("gt_fare").textContent),
    parseNum(document.getElementById("gt_grand").textContent),
  ]);

  const ws = XLSX.utils.aoa_to_sheet(aoa);
  ws["!cols"] = [
    {wch:12},{wch:10},{wch:10},{wch:12},{wch:12},{wch:12},{wch:8},{wch:12},{wch:12}
  ];

  XLSX.utils.book_append_sheet(wb, ws, "TA_DA");
  XLSX.writeFile(wb, makeFileName("TA_DA_Sheet","xlsx"));
}

/* ===== INIT ===== */
(function init(){
  bindMeta();

  const ok = loadAll();
  if(!ok){
    // start with 1 range row by default
    addRangeUI();
    // and 1 empty claim row
    addRow({});
  }

  setHeaderFromInputs();
  applyDesignationRates();
  recalcTotals();
  updateRateBadge();
})();
</script>
</body>
</html>