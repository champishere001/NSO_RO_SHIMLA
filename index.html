<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLFS Pro - CSV Export</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --page-bg: #020617; --sidebar-bg: #0f172a; --accent-blue: #06b6d4;
            --milky-white: #fdfaf6; --row-bg: #fffbf7; --row-border: #eaddcf;
            --text-dark: #1e293b;
        }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; background-color: var(--page-bg); display: flex; height: 100vh; color: white; overflow: hidden; }

        .sidebar { width: 240px; background: var(--sidebar-bg); display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.1); transition: 0.3s ease; z-index: 2000; }
        .sidebar-scroll { overflow-y: auto; flex: 1; padding: 12px; scrollbar-width: none; }
        .section-label { font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin: 15px 0 8px 5px; }
        
        .state-item { padding: 10px 14px; margin-bottom: 4px; border-radius: 10px; cursor: pointer; font-weight: 700; color: #94a3b8; font-size: 13px; background: rgba(255,255,255,0.02); }
        .state-item.active { background: rgba(6, 182, 212, 0.1); color: var(--accent-blue); border: 1px solid rgba(6, 182, 212, 0.3); }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #020617; }
        .header-container { height: 60px; background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        
        .progress-container { width: 80px; height: 6px; background: #1e293b; border-radius: 10px; overflow: hidden; }
        #pBar { height: 100%; width: 0%; transition: width 0.6s ease; }

        .dashboard-content { display: flex; flex: 1; overflow-y: auto; padding: 12px; gap: 12px; }
        .pane-v1 { flex: 2.3; background: var(--milky-white); border-radius: 16px; display: flex; flex-direction: column; border: 1px solid #dcd3c9; overflow: hidden; }
        .pane-rv { flex: 1; background: var(--milky-white); border-radius: 16px; display: flex; flex-direction: column; border: 1px solid #dcd3c9; overflow: hidden; }
        
        .pane-header { padding: 10px 15px; background: #f1ebe4; font-size: 10px; font-weight: 800; color: #7c746d; border-bottom: 2px solid var(--row-border); display: flex; justify-content: space-between; align-items: center; }
        .search-input { background: white; border: 1px solid #dcd3c9; border-radius: 6px; padding: 4px 8px; font-size: 11px; width: 110px; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #fdfaf7; padding: 8px 10px; text-align: left; font-size: 9px; color: #a39b94; text-transform: uppercase; border-bottom: 1px solid var(--row-border); }
        td { padding: 8px 10px; border-bottom: 1px solid var(--row-border); font-size: 13px; background-color: var(--row-bg); color: var(--text-dark); font-weight: 600; }
        
        input { border: 1px solid rgba(0,0,0,0.1); background: white; width: 100%; font-size: 12px; padding: 6px; border-radius: 6px; }

        .btn-action { padding: 8px 14px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 11px; transition: 0.2s; }
        .btn-push { background: var(--accent-blue); color: #083344; }
        .btn-csv { background: #10b981; color: white; margin-right: 8px; }

        @media (max-width: 768px) {
            .sidebar { position: absolute; left: -240px; height: 100%; }
            .sidebar.open { left: 0; box-shadow: 10px 0 50px rgba(0,0,0,0.8); }
            .dashboard-content { flex-direction: column; }
            thead { display: none; }
            tr { display: flex; flex-direction: column; padding: 12px; border-bottom: 6px solid #f1ebe4; background: var(--row-bg); }
            td { display: block; padding: 4px 0; border: none; width: 100% !important; }
            td::before { content: attr(data-label); display: block; font-size: 8px; color: #a39b94; text-transform: uppercase; }
        }

        .menu-btn { background: var(--accent-blue); color: #083344; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 800; cursor: pointer; display: none; }
        @media (max-width: 768px) { .menu-btn { display: block; } }

        #loginOverlay { position: fixed; inset: 0; background: var(--page-bg); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: #111827; padding: 30px; border-radius: 20px; width: 320px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .chip { font-size: 9px; padding: 8px 2px; text-align: center; border-radius: 6px; cursor: pointer; font-weight: 700; color: #94a3b8; background: rgba(255,255,255,0.05); }
        .chip.active { background: var(--accent-blue); color: #083344; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 style="color: white; margin-bottom: 25px;">PLFS HUB</h2>
        <button class="btn-action" style="background: var(--accent-blue); width:100%; margin-bottom:10px; padding:15px;" onclick="loginAsState()">STATE ACCESS</button>
        <button class="btn-action" style="background: #1e293b; color: white; width:100%; padding:12px;" onclick="showPassInput()">ADMIN LOGIN</button>
        <div id="passArea" style="display:none; margin-top: 15px;">
            <input type="password" id="adminPass" placeholder="PIN" style="text-align: center; margin-bottom:10px; background: #0f172a; color: white; padding: 10px; border-radius: 8px; border: 1px solid #334155;">
            <button class="btn-action btn-push" style="width:100%" onclick="validateAdmin()">VERIFY</button>
        </div>
    </div>
</div>

<aside class="sidebar" id="sidebar">
    <div style="padding: 20px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 900; color: white; font-size: 16px;">PLFS SYNC</span>
        <button class="menu-btn" style="padding: 4px 8px; font-size: 10px;" onclick="toggleSidebar()">âœ•</button>
    </div>
    <div class="sidebar-scroll" id="sidebarContent"></div>
</aside>

<div class="main">
    <header class="header-container">
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="menu-btn" onclick="toggleSidebar()">MENU</button>
            <div id="breadcrumb" style="font-size: 12px; font-weight: 700; color: #94a3b8;">Dashboard</div>
        </div>
        <div style="display:flex; align-items: center; gap:8px;">
            <div class="progress-wrapper" style="margin-right: 10px;">
                <div class="progress-container"><div id="pBar"></div></div>
                <div id="pText" style="font-size: 8px; font-weight: 800; color: #64748b; margin-top: 2px; text-align: right;">0%</div>
            </div>
            <button class="btn-action btn-csv" onclick="exportToCSV()">GENERATE CSV</button>
            <button class="btn-action btn-push" onclick="saveToCloud()">PUSH DATA</button>
        </div>
    </header>

    <div class="dashboard-content">
        <section class="pane-v1">
            <div class="pane-header"><span>V1 (FRESH)</span><input type="text" class="search-input" placeholder="Search..." onkeyup="filterData(this.value)"></div>
            <div style="flex:1; overflow:auto;"><table><thead><tr><th width="70">FSU</th><th>VILLAGE</th><th width="130">ENUMERATOR</th><th width="110">TARGET</th></tr></thead><tbody id="freshBody"></tbody></table></div>
        </section>
        <section class="pane-rv">
            <div class="pane-header"><span>RV (REVISITS)</span></div>
            <div style="flex:1; overflow:auto;"><table><thead><tr><th width="100">UID</th><th>ENUM</th><th width="110">DATE</th></tr></thead><tbody id="rvBody"></tbody></table></div>
        </section>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB6fQ8n4qyG-TfVdAqWtDped17bMYTZSgI",
        authDomain: "action-plan-62fae.firebaseapp.com",
        databaseURL: "https://action-plan-62fae-default-rtdb.firebaseio.com",
        projectId: "action-plan-62fae"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let masterData = [], isAdmin = false, selectedState = null, selectedMonth = null, selectedSro = null, searchQuery = "";
    const monthsShort = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function showPassInput() { document.getElementById('passArea').style.display = 'block'; }
    function validateAdmin() { if(document.getElementById('adminPass').value === '12345') { isAdmin = true; document.getElementById('loginOverlay').style.display = 'none'; loadFromFirebase(); } else alert("Invalid PIN"); }
    function loginAsState() { isAdmin = false; document.getElementById('loginOverlay').style.display = 'none'; loadFromFirebase(); }

    async function loadFromFirebase() {
        const snap = await database.ref('plfs_roster').once('value');
        if (snap.exists()) {
            const raw = snap.val();
            masterData = Object.keys(raw).flatMap(k => Object.values(raw[k]));
        }
        renderSidebar();
    }

    function renderSidebar() {
        const container = document.getElementById('sidebarContent'); container.innerHTML = "";
        const states = [...new Set(masterData.map(d => d.state))].sort();
        
        states.forEach(st => {
            const stDiv = document.createElement('div');
            stDiv.className = `state-item ${selectedState === st ? 'active' : ''}`;
            stDiv.innerText = st;
            stDiv.onclick = () => { selectedState = (selectedState === st) ? null : st; selectedMonth = null; selectedSro = null; renderSidebar(); updateDisplay(); };
            container.appendChild(stDiv);

            if (selectedState === st) {
                const sub = document.createElement('div'); sub.style.paddingLeft = "8px";
                const mGrid = document.createElement('div'); mGrid.style.display = 'grid'; mGrid.style.gridTemplateColumns = 'repeat(3, 1fr)'; mGrid.style.gap = '5px';
                monthsShort.forEach((m, i) => {
                    const ch = document.createElement('div'); ch.className = `chip ${selectedMonth === i ? 'active' : ''}`; ch.innerText = m;
                    ch.onclick = (e) => { e.stopPropagation(); selectedMonth = i; selectedSro = null; renderSidebar(); updateDisplay(); };
                    mGrid.appendChild(ch);
                });
                sub.appendChild(mGrid);

                if (selectedMonth !== null) {
                    const sros = [...new Set(masterData.filter(d => d.state === st).map(d => d.sro))].sort();
                    const allCh = document.createElement('div'); allCh.className = `chip ${selectedSro === 'ALL' ? 'active' : ''}`; allCh.style.width = '100%'; allCh.style.marginTop = '10px'; allCh.innerText = "ALL REGIONS";
                    allCh.onclick = (e) => { e.stopPropagation(); selectedSro = 'ALL'; renderSidebar(); updateDisplay(); };
                    sub.appendChild(allCh);
                    sros.forEach(sr => {
                        const srCh = document.createElement('div'); srCh.className = `chip ${selectedSro === sr ? 'active' : ''}`; srCh.style.width = '100%'; srCh.style.marginTop = '5px'; srCh.innerText = sr || 'Unassigned';
                        srCh.onclick = (e) => { e.stopPropagation(); selectedSro = sr; renderSidebar(); updateDisplay(); };
                        sub.appendChild(srCh);
                    });
                }
                container.appendChild(sub);
            }
        });
    }

    function filterData(val) { searchQuery = val.toLowerCase(); updateDisplay(); }

    function updateDisplay() {
        if (!selectedState || selectedMonth === null) return;
        const stateSet = masterData.filter(d => d.state === selectedState && (selectedSro === 'ALL' || !selectedSro ? true : d.sro === selectedSro));
        let filtered = [];
        
        if (selectedMonth <= 2) {
            stateSet.forEach(d => {
                if (d.monthIdx === selectedMonth && d.visit === 1) filtered.push(d);
                else if (selectedMonth === 1 && d.monthIdx === 0 && d.visit === 1) filtered.push({...d, visit: 2, uid: d.fsu + '-V2'});
                else if (selectedMonth === 2 && (d.monthIdx === 0 || d.monthIdx === 1) && d.visit === 1) filtered.push({...d, visit: 2, uid: d.fsu + '-RV'});
            });
        } else {
            filtered = stateSet.filter(d => d.monthIdx === selectedMonth);
        }

        filtered = filtered.filter(d => d.fsu.toString().includes(searchQuery) || d.village.toLowerCase().includes(searchQuery));
        const fBody = document.getElementById('freshBody'); fBody.innerHTML = "";
        const rBody = document.getElementById('rvBody'); rBody.innerHTML = "";
        let comp = 0;

        filtered.forEach(d => {
            const isDone = d.visit === 1 ? d.endDate : d.collectionDate; if (isDone) comp++;
            if (d.visit === 1) {
                fBody.innerHTML += `<tr><td data-label="FSU">${d.fsu}</td><td data-label="Village">${d.village}</td><td><input type="text" value="${d.enumerator||''}" onchange="updateVal('${d.uid}','enumerator',this.value)"></td><td><input type="date" value="${d.endDate||''}" onchange="updateVal('${d.uid}','endDate',this.value)"></td></tr>`;
            } else {
                rBody.innerHTML += `<tr><td data-label="UID">${d.uid}</td><td>${d.enumerator||'--'}</td><td><input type="date" value="${d.collectionDate||''}" onchange="updateVal('${d.uid}','collectionDate',this.value)"></td></tr>`;
            }
        });
        const per = filtered.length > 0 ? Math.round((comp/filtered.length)*100) : 0;
        document.getElementById('pBar').style.width = per+"%"; document.getElementById('pText').innerText = per+"%";
    }

    function updateVal(uid, key, val) { const item = masterData.find(d => d.uid === uid); if (item) { item[key] = val; updateDisplay(); } }

    async function saveToCloud() {
        if(!selectedState) return;
        const stateData = masterData.filter(d => d.state === selectedState);
        const dataObj = {}; stateData.forEach(item => dataObj[item.uid] = item);
        await database.ref(`plfs_roster/${selectedState}`).set(dataObj);
        alert("Cloud Pushed!");
    }

    // --- CSV GENERATION LOGIC ---
    function exportToCSV() {
        if (!selectedState || selectedMonth === null) return alert("Select State/Month first");
        
        // Re-calculate the filtered set as shown in UI
        const stateSet = masterData.filter(d => d.state === selectedState && (selectedSro === 'ALL' || !selectedSro ? true : d.sro === selectedSro));
        let exportData = [];
        
        if (selectedMonth <= 2) {
            stateSet.forEach(d => {
                if (d.monthIdx === selectedMonth && d.visit === 1) exportData.push({...d, type: 'V1'});
                else if (selectedMonth === 1 && d.monthIdx === 0 && d.visit === 1) exportData.push({...d, uid: d.fsu + '-V2', type: 'V2'});
                else if (selectedMonth === 2 && (d.monthIdx === 0 || d.monthIdx === 1) && d.visit === 1) exportData.push({...d, uid: d.fsu + '-RV', type: 'RV'});
            });
        } else {
            exportData = stateSet.filter(d => d.monthIdx === selectedMonth).map(d => ({...d, type: d.visit === 1 ? 'V1' : 'RV'}));
        }

        const headers = ["FSU_UID", "Village", "Enumerator", "Target_Collection_Date", "Visit_Type", "SRO"];
        const rows = exportData.map(d => [
            d.uid || d.fsu,
            d.village,
            d.enumerator || "Unassigned",
            d.visit === 1 ? (d.endDate || "N/A") : (d.collectionDate || "N/A"),
            d.type,
            d.sro || "N/A"
        ]);

        let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(r => r.join(",")).join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `PLFS_${selectedState}_${monthsShort[selectedMonth]}.csv`);
        document.body.appendChild(link);
        link.click();
    }
</script>
</body>
</html>
