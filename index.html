<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MoSPI PLFS Master Roster</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --mospi-blue: #1a237e; --mospi-gold: #ffd700; --bg: #f4f7f9;
            --border: #d1d5db; --text: #1f2937; --white: #ffffff;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); overflow: hidden; }

        /* Sidebar - Month Rail */
        .month-rail { width: 70px; background: #0a0e27; display: flex; flex-direction: column; padding: 10px 0; flex-shrink: 0; }
        .month-tab { 
            padding: 15px 0; color: #9ca3af; cursor: pointer; text-align: center; 
            font-size: 10px; font-weight: 700; transition: 0.3s; border-left: 3px solid transparent;
        }
        .month-tab.active { color: var(--mospi-gold); background: rgba(255,255,255,0.1); border-left-color: var(--mospi-gold); }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Official MoSPI Header */
        .mospi-header {
            background: var(--mospi-blue); color: white; padding: 10px 30px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 4px solid var(--mospi-gold); box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .gov-branding { display: flex; align-items: center; gap: 15px; }
        .gov-text h1 { margin: 0; font-size: 18px; letter-spacing: 1px; text-transform: uppercase; }
        .gov-text p { margin: 0; font-size: 11px; color: #e0e0e0; }

        /* Filter Toolbar */
        .toolbar {
            background: white; padding: 12px 30px; display: flex; align-items: center; gap: 20px;
            border-bottom: 1px solid var(--border);
        }
        .filter-group { display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600; }
        select, .btn { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); font-family: inherit; font-size: 12px; }
        .btn-sync { background: var(--mospi-blue); color: white; border: none; cursor: pointer; font-weight: 700; padding: 8px 20px; }
        .btn-sync:hover { background: #283593; }

        /* Dashboard View */
        .dashboard { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; }
        .pane { background: var(--white); border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; }
        .pane-60 { width: 60%; }
        .pane-40 { width: 40%; background: #fafbfc; }

        .section-label { 
            padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid var(--border);
            font-size: 12px; font-weight: 800; color: var(--mospi-blue); text-transform: uppercase;
        }

        .table-area { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 12px 15px; text-align: left; font-size: 11px; color: #475569; position: sticky; top: 0; }
        td { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; font-size: 12.5px; }

        input { width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px; outline: none; }
        input:focus { border-color: var(--mospi-blue); }
    </style>
</head>
<body>

    <div class="month-rail" id="monthRail"></div>

    <div class="main-content">
        <header class="mospi-header">
            <div class="gov-branding">
                <div style="font-size: 24px;">üèõÔ∏è</div>
                <div class="gov-text">
                    <h1>Government of India</h1>
                    <p>Ministry of Statistics and Programme Implementation (MoSPI)</p>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 14px; font-weight: 700; color: var(--mospi-gold);">PLFS MASTER ROSTER 2026</div>
                <div style="font-size: 10px;">Periodic Labour Force Survey Dashboard</div>
            </div>
        </header>

        <div class="toolbar">
            <div class="filter-group">
                <span>State:</span>
                <select id="stateFilter" onchange="applyFilters()"><option value="all">All States</option></select>
            </div>
            <div class="filter-group">
                <span>SRO:</span>
                <select id="sroFilter" onchange="applyFilters()"><option value="all">All SROs</option></select>
            </div>
            <div style="flex-grow: 1;"></div>
            <button class="btn" onclick="document.getElementById('fileInput').click()">üìÇ Import Files</button>
            <button class="btn-sync" onclick="saveToCloud()">‚òÅÔ∏è Sync to Firebase</button>
            <input type="file" id="fileInput" multiple style="display:none" onchange="handleUpload(this)">
        </div>

        <div class="dashboard">
            <div class="pane pane-60">
                <div class="section-label">Visit 1: Fresh Samples (First Visit Window)</div>
                <div class="table-area">
                    <table>
                        <thead>
                            <tr><th>FSU</th><th>Village/Town</th><th>Enumerator Name</th><th>Start Date</th><th>End Date</th></tr>
                        </thead>
                        <tbody id="freshBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="pane pane-40">
                <div class="section-label">Visits 2, 3, 4: Revisit Tracking</div>
                <div class="table-area">
                    <table>
                        <thead>
                            <tr><th>UID</th><th>Enumerator</th><th>Collection Date</th></tr>
                        </thead>
                        <tbody id="revisitBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB6fQ8n4qyG-TfVdAqWtDped17bMYTZSgI",
        authDomain: "action-plan-62fae.firebaseapp.com",
        databaseURL: "https://action-plan-62fae-default-rtdb.firebaseio.com",
        projectId: "action-plan-62fae"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    let masterData = [];
    let selectedMonth = new Date().getMonth();

    const rail = document.getElementById('monthRail');
    months.forEach((m, i) => {
        rail.innerHTML += `<div class="month-tab ${i === selectedMonth ? 'active' : ''}" onclick="changeMonth(${i})">${m.substring(0,3).toUpperCase()}</div>`;
    });

    async function handleUpload(input) {
        if (!input.files.length) return;
        let states = new Set();
        let sros = new Set();

        for (let file of input.files) {
            const buffer = await file.arrayBuffer();
            const raw = XLSX.utils.sheet_to_json(XLSX.read(buffer).Sheets[XLSX.read(buffer).Sheets[0]], {range: 7});
            
            raw.forEach(r => {
                if (!r.FSU) return;
                const state = String(r['State/UT'] || 'Unknown').trim();
                const sro = String(r['SRO [Code]'] || 'N/A').replace(/\[.*?\]/g, "").trim();
                states.add(state); sros.add(sro);
                
                const baseMonth = (parseInt(String(r['Month [Qtr]']).match(/\d+/)) - 1) % 12;

                for (let v = 1; v <= 4; v++) {
                    masterData.push({
                        uid: `${r.FSU}-V${v}`, fsu: r.FSU, visit: v, sro: sro, state: state,
                        monthIdx: (baseMonth + (v - 1)) % 12,
                        village: String(r['Village[Code]'] || r['Town [Code]'] || 'N/A').replace(/\[.*?\]/g, "").trim(),
                        enumerator: "", startDate: "", endDate: "", collectionDate: ""
                    });
                }
            });
        }
        updateDropdown('stateFilter', states);
        updateDropdown('sroFilter', sros);
        applyFilters();
    }

    function updateDropdown(id, set) {
        const el = document.getElementById(id);
        el.innerHTML = `<option value="all">All ${id.includes('state') ? 'States' : 'SROs'}</option>`;
        Array.from(set).sort().forEach(val => el.innerHTML += `<option value="${val}">${val}</option>`);
    }

    function changeMonth(idx) {
        selectedMonth = idx;
        document.querySelectorAll('.month-tab').forEach((t, i) => t.className = `month-tab ${i === idx ? 'active' : ''}`);
        applyFilters();
    }

    function applyFilters() {
        const state = document.getElementById('stateFilter').value;
        const sro = document.getElementById('sroFilter').value;
        const filtered = masterData.filter(d => 
            d.monthIdx === selectedMonth && 
            (state === 'all' || d.state === state) &&
            (sro === 'all' || d.sro === sro)
        );
        renderTables(filtered);
    }

    function renderTables(data) {
        const fBody = document.getElementById('freshBody');
        const rBody = document.getElementById('revisitBody');
        fBody.innerHTML = ""; rBody.innerHTML = "";

        data.forEach(d => {
            if (d.visit === 1) {
                fBody.innerHTML += `<tr>
                    <td><b>${d.fsu}</b></td><td>${d.village}</td>
                    <td><input value="${d.enumerator}" onchange="syncName('${d.fsu}', this.value)"></td>
                    <td><input type="date" value="${d.startDate}" onchange="setWindow('${d.uid}', this.value)"></td>
                    <td><input type="date" value="${d.endDate}" id="end-${d.uid}" onchange="updateData('${d.uid}', 'endDate', this.value)"></td>
                </tr>`;
            } else {
                rBody.innerHTML += `<tr>
                    <td>${d.uid}</td><td id="e-${d.uid}" style="color:var(--mospi-blue); font-weight:700;">${d.enumerator || '--'}</td>
                    <td><input type="date" value="${d.collectionDate}" onchange="updateData('${d.uid}', 'collectionDate', this.value)"></td>
                </tr>`;
            }
        });
    }

    function syncName(fsu, name) {
        masterData.forEach(item => { if (item.fsu === fsu) { item.enumerator = name; let el = document.getElementById(`e-${item.uid}`); if (el) el.innerText = name; } });
    }

    function setWindow(uid, start) {
        const item = masterData.find(d => d.uid === uid);
        if (item && start) {
            item.startDate = start;
            let d = new Date(start); d.setDate(d.getDate() + 5);
            item.endDate = d.toISOString().split('T')[0];
            const endEl = document.getElementById(`end-${uid}`); if (endEl) endEl.value = item.endDate;
        }
    }

    function updateData(uid, key, val) { const item = masterData.find(d => d.uid === uid); if (item) item[key] = val; }

    async function saveToCloud() {
        if (!masterData.length) return;
        await database.ref('mospi_plfs/master').set(masterData);
        alert("Official Roster Synced to Firebase!");
    }
</script>
</body>
</html>
